<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réinitialisation Mot de Passe - AYNA</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="https://ayna.app/logo.png">
</head>
<body>
    <div class="container">
        <div class="logo">✨</div>
        <h1>Réinitialisation Mot de Passe</h1>
        
        <div id="status" class="status loading hidden">
            <div>
                <div class="spinner"></div>
                <p id="statusMessage">Traitement en cours...</p>
            </div>
        </div>

        <div id="formContent">
            <p class="description">
                Entrez votre nouveau mot de passe ci-dessous.
            </p>
            
            <form id="resetForm" onsubmit="handleResetPassword(event)">
                <div class="form-group">
                    <label for="password">Nouveau mot de passe</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required 
                        minlength="6"
                        placeholder="Minimum 6 caractères"
                        class="input"
                    />
                    <div class="password-requirements">
                        <small>Le mot de passe doit contenir au moins 6 caractères</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmer le mot de passe</label>
                    <input 
                        type="password" 
                        id="confirmPassword" 
                        name="confirmPassword" 
                        required 
                        minlength="6"
                        placeholder="Répétez le mot de passe"
                        class="input"
                    />
                </div>

                <button type="submit" class="button" id="submitButton">
                    Réinitialiser le mot de passe
                </button>
            </form>
        </div>

        <div id="successContent" class="hidden">
            <div class="icon success">✓</div>
            <p>Votre mot de passe a été réinitialisé avec succès !</p>
            <p style="margin-top: 12px; font-size: 14px; opacity: 0.8;">
                Vous pouvez maintenant vous connecter avec votre nouveau mot de passe.
            </p>
            <button class="button" onclick="redirectToApp()">Ouvrir l'application</button>
        </div>

        <div id="errorContent" class="hidden">
            <div class="icon error">✗</div>
            <p id="errorMessage">Une erreur est survenue lors de la réinitialisation.</p>
            <button class="button" onclick="retryReset()">Réessayer</button>
            <a href="ayna://" class="link">Ouvrir l'application</a>
        </div>

        <p class="info">
            La réinitialisation est effectuée de manière sécurisée via notre serveur.
        </p>
    </div>

    <script src="auth.js"></script>
    <script>
        // Configuration Supabase Edge Function
        const SUPABASE_URL = 'https://ctupecolapegiogvmwxz.supabase.co';
        const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/reset-password`;

        // Récupérer les paramètres depuis l'URL (query string et hash)
        const urlParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        
        // Essayer d'abord dans la query string, puis dans le hash
        const token = urlParams.get('token') || urlParams.get('code') || hashParams.get('token') || hashParams.get('code');
        const tokenHash = urlParams.get('token_hash') || hashParams.get('token_hash');
        const typeHash = urlParams.get('type_hash') || hashParams.get('type_hash');
        const type = urlParams.get('type') || hashParams.get('type') || 'recovery';

        // Vérifier que le token est présent
        if (!token && !tokenHash) {
            document.getElementById('formContent').classList.add('hidden');
            document.getElementById('errorContent').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = 'Lien de réinitialisation invalide ou expiré.';
        }

        async function handleResetPassword(event) {
            event.preventDefault();

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const formContent = document.getElementById('formContent');
            const statusDiv = document.getElementById('status');
            const successDiv = document.getElementById('successContent');
            const errorDiv = document.getElementById('errorContent');
            const submitButton = document.getElementById('submitButton');

            // Validation
            if (password !== confirmPassword) {
                showError('Les mots de passe ne correspondent pas.');
                return;
            }

            if (password.length < 6) {
                showError('Le mot de passe doit contenir au moins 6 caractères.');
                return;
            }

            if (!token && !tokenHash) {
                showError('Lien de réinitialisation invalide ou expiré.');
                return;
            }

            try {
                // Afficher le statut de chargement
                formContent.classList.add('hidden');
                statusDiv.classList.remove('hidden');
                submitButton.disabled = true;

                // Appeler l'Edge Function Supabase (sécurisé)
                const response = await fetch(EDGE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        token_hash: tokenHash,
                        type: 'recovery',
                        type_hash: typeHash,
                        password: password
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showSuccess();
                } else {
                    throw new Error(data.error || 'Erreur lors de la réinitialisation');
                }

            } catch (error) {
                console.error('Erreur réinitialisation:', error);
                showError(error.message || 'Une erreur est survenue lors de la réinitialisation.');
            } finally {
                statusDiv.classList.add('hidden');
                submitButton.disabled = false;
            }
        }

        function showSuccess() {
            const formContent = document.getElementById('formContent');
            const statusDiv = document.getElementById('status');
            const successDiv = document.getElementById('successContent');
            const errorDiv = document.getElementById('errorContent');

            formContent.classList.add('hidden');
            statusDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');
            successDiv.classList.remove('hidden');
        }

        function showError(message) {
            const formContent = document.getElementById('formContent');
            const statusDiv = document.getElementById('status');
            const successDiv = document.getElementById('successContent');
            const errorDiv = document.getElementById('errorContent');
            const errorMessage = document.getElementById('errorMessage');

            formContent.classList.remove('hidden');
            statusDiv.classList.add('hidden');
            successDiv.classList.add('hidden');
            errorDiv.classList.remove('hidden');
            errorMessage.textContent = message;
        }

        function retryReset() {
            const formContent = document.getElementById('formContent');
            const errorDiv = document.getElementById('errorContent');

            formContent.classList.remove('hidden');
            errorDiv.classList.add('hidden');
        }

        function redirectToApp() {
            window.location.href = 'ayna://reset-password-success';
            setTimeout(() => {
                window.location.href = 'https://ayna.app';
            }, 1000);
        }
    </script>
</body>
</html>

